{% extends "base.html" %}

{% block title %}{{ member.name|title }} - Medical Data Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="text-capitalize mb-1">
                    <i class="bi bi-person me-2"></i>
                    {{ member.name }}
                </h2>
                <p class="text-muted mb-0">
                    <i class="bi bi-credit-card me-1"></i>
                    Member ID: <strong>{{ member.member_id }}</strong>
                </p>
            </div>
            <div class="btn-group">
                <a href="{{ url_for('update_member', member_id=member.member_id) }}" 
                   class="btn btn-primary">
                    <i class="bi bi-pencil me-2"></i>Edit
                </a>
                <a href="{{ url_for('upload_file', member_id=member.member_id) }}" 
                   class="btn btn-success">
                    <i class="bi bi-upload me-2"></i>Upload File
                </a>
                <button type="button" 
                        class="btn btn-danger" 
                        data-bs-toggle="modal" 
                        data-bs-target="#deleteModal">
                    <i class="bi bi-trash me-2"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Personal Information -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-person me-2"></i>Personal Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Full Name:</strong></div>
                    <div class="col-sm-8 text-capitalize">{{ member.name }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Date of Birth:</strong></div>
                    <div class="col-sm-8">{{ member.date_of_birth.strftime('%B %d, %Y') }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Age:</strong></div>
                    <div class="col-sm-8">{{ member.age }} years old</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Gender:</strong></div>
                    <div class="col-sm-8">{{ member.gender }}</div>
                </div>
                <div class="row">
                    <div class="col-sm-4"><strong>Member Since:</strong></div>
                    <div class="col-sm-8">{{ member.created_at.strftime('%B %d, %Y') }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Medical Overview (without diagnoses) -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clipboard-pulse me-2"></i>Medical Overview
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-12 col-sm-4"><strong>Doctors:</strong></div>
                    <div class="col-12 col-sm-8">
                        {% if member.doctors %}
                            <div class="doctors-container d-flex flex-wrap">
                                {% for doctor in member.doctors %}
                                    <span class="badge bg-primary me-1 mb-1 doctor-badge">{{ doctor.name }}</span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <span class="text-muted">No doctors assigned</span>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-sm-4"><strong>Medications:</strong></div>
                    <div class="col-12 col-sm-8">
                        {% if member.medications %}
                            <div class="medications-container d-flex flex-wrap">
                                {% for medication in member.medications %}
                                    <span class="badge bg-success me-1 mb-1 medication-badge">{{ medication.name }}</span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <span class="text-muted">No current medications</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Medical Conditions -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clipboard-check me-2"></i>Underlying Conditions
                </h5>
            </div>
            <div class="card-body">
                {% if member.underlying %}
                    {% for condition in member.underlying.split(',') %}
                        <p class="mb-2 condition-item">
                            <i class="bi bi-dot text-primary me-1"></i>
                            {{ condition.strip() }}
                        </p>
                    {% endfor %}
                {% else %}
                    <p class="text-muted mb-0">No underlying conditions recorded</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle me-2"></i>Drug Allergies
                </h5>
            </div>
            <div class="card-body">
                {% if member.drug_allergy %}
                    <p class="mb-0 text-danger">
                        <i class="bi bi-shield-exclamation me-1"></i>
                        {{ member.drug_allergy }}
                    </p>
                {% else %}
                    <p class="text-muted mb-0">No known drug allergies</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-clipboard-data me-2"></i>Medical Diagnoses
                    {% if sorted_diagnoses %}
                        <span class="badge bg-secondary ms-2">{{ sorted_diagnoses|length }}</span>
                    {% endif %}
                </h5>
                <!-- Toggle button for expand/collapse -->
                <button class="btn btn-sm btn-outline-light" 
                        type="button" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#diagnosesTable" 
                        aria-expanded="true" 
                        aria-controls="diagnosesTable"
                        id="diagnosesToggle">
                    <i class="bi bi-chevron-up" id="toggleIcon"></i>
                    <span id="toggleText">Hide Details</span>
                </button>
            </div>
            <div class="collapse show" id="diagnosesTable">
                <div class="card-body">
                    {% if sorted_diagnoses %}
                        <div class="diagnoses-timeline">
                            {% for diagnosis in sorted_diagnoses %}
                                <div class="diagnosis-item p-3 mb-3 bg-light rounded position-relative" 
                                     data-date="{{ diagnosis.created_at.strftime('%Y-%m-%d') }}">
                                    <!-- Date badge - positioned at top right -->
                                    <div class="date-badge">
                                        <span class="badge bg-info">
                                            <i class="bi bi-calendar3 me-1"></i>
                                            {{ diagnosis.created_at.strftime('%m/%d/%Y') }}
                                        </span>
                                        {% if diagnosis.updated_at and diagnosis.updated_at != diagnosis.created_at %}
                                            <small class="text-muted d-block mt-1">
                                                Updated: {{ diagnosis.updated_at.strftime('%m/%d/%Y') }}
                                            </small>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Main content -->
                                    <div class="diagnosis-content">
                                        <span class="badge bg-primary me-2 diagnosis-number">{{ loop.index }}</span>
                                        <span class="diagnosis-name">{{ diagnosis.name }}</span>
                                    </div>
                                    
                                    <!-- Time since diagnosis (fixed version) -->
<div class="time-indicator mt-2">
    <small class="text-muted">
        <i class="bi bi-clock me-1"></i>
        {% if diagnosis.created_at %}
            {% set days_ago = (moment().date() - diagnosis.created_at.date()).days if moment is defined else ((now().date() - diagnosis.created_at.date()).days if now is defined else 0) %}
            {% if days_ago == 0 %}
                Added today
            {% elif days_ago == 1 %}
                Added yesterday
            {% elif days_ago < 7 %}
                Added {{ days_ago }} days ago
            {% elif days_ago < 30 %}
                Added {{ (days_ago / 7)|round|int }} weeks ago
            {% else %}
                Added {{ diagnosis.created_at.strftime('%B %Y') }}
            {% endif %}
        {% else %}
            Added (date unknown)
        {% endif %}
    </small>
</div>
                        
                        <!-- Summary information -->
                        <div class="diagnoses-summary mt-3 p-2 bg-info bg-opacity-10 rounded">
                            <small class="text-info">
                                <i class="bi bi-info-circle me-1"></i>
                                <strong>{{ sorted_diagnoses|length }}</strong> total diagnoses • 
                                Latest: {{ sorted_diagnoses[0].created_at.strftime('%B %d, %Y') }} •
                                Oldest: {{ sorted_diagnoses[-1].created_at.strftime('%B %d, %Y') }}
                            </small>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-clipboard-x text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mb-0 mt-2">No diagnoses recorded yet</p>
                            <small class="text-muted">Add diagnoses through the Edit button above</small>
                        </div>
                    {% endif %}      
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Medical Files -->
{% if member.medical_files %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-files me-2"></i>Medical Files
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>File Name</th>
                                <th>Description</th>
                                <th>Size</th>
                                <th>Upload Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in member.medical_files %}
                            <tr>
                                <td>
                                    <i class="bi bi-file-earmark me-1"></i>
                                    {{ file.filename }}
                                </td>
                                <td>{{ file.description or 'No description' }}</td>
                                <td>{{ "%.2f"|format(file.file_size / 1024 / 1024) }} MB</td>
                                <td>{{ file.uploaded_at.strftime('%m/%d/%Y') }}</td>
                                <td>
                                    <a href="{{ url_for('download_file', file_id=file.id) }}" 
                                       class="btn btn-sm btn-outline-primary me-1">
                                        <i class="bi bi-download"></i>
                                    </a>
                                    <form method="POST" 
                                          action="{{ url_for('delete_file', file_id=file.id) }}" 
                                          class="d-inline">
                                        <button type="submit" 
                                                class="btn btn-sm btn-outline-danger"
                                                onclick="return confirm('Are you sure you want to delete this file?')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                    Confirm Deletion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong class="text-capitalize">{{ member.name }}</strong>?</p>
                <p class="text-danger">
                    <i class="bi bi-warning me-1"></i>
                    This action cannot be undone and will permanently delete all associated medical records and files.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('delete_member', member_id=member.member_id) }}" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-2"></i>Delete Member
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for interactive features -->
<script>
// Tutorial: JavaScript functions for beginners
// This section handles the interactive features of our medical data interface

// Simple toggle function for diagnoses section
document.addEventListener('DOMContentLoaded', function() {
    // Wait for the page to fully load before running our code
    
    // Get references to the elements we need to control
    const diagnosesSection = document.getElementById('diagnosesTable');
    const toggleIcon = document.getElementById('toggleIcon');
    const toggleText = document.getElementById('toggleText');
    
    // Check if the elements exist before adding event listeners
    if (diagnosesSection && toggleIcon && toggleText) {
        // Listen for when the collapse/expand happens
        diagnosesSection.addEventListener('hidden.bs.collapse', function () {
            // When section is hidden, change icon and text
            toggleIcon.className = 'bi bi-chevron-down';
            toggleText.textContent = 'Show Details';
        });
        
        diagnosesSection.addEventListener('shown.bs.collapse', function () {
            // When section is shown, change icon and text back
            toggleIcon.className = 'bi bi-chevron-up';
            toggleText.textContent = 'Hide Details';
        });
    }
});
</script>

<!-- Enhanced CSS for responsive design -->
<style>
/* Tutorial: CSS Styling for Beginners */

/* Simple styling for the diagnoses toggle button */
#diagnosesToggle {
    border: 1px solid rgba(255,255,255,0.3);
    transition: all 0.3s ease; /* Smooth animation when hovering */
}

#diagnosesToggle:hover {
    background-color: rgba(255,255,255,0.1);
    border-color: rgba(255,255,255,0.5);
}

/* Enhanced styling for underlying conditions */
.condition-item {
    padding: 0.5rem 0.75rem;
    background-color: #f8f9fa;
    border-left: 3px solid #0d6efd;
    border-radius: 0.25rem;
    transition: all 0.2s ease;
    font-weight: 500;
    color: #495057;
}

.condition-item:hover {
    background-color: #e3f2fd;
    transform: translateX(3px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.condition-item:last-child {
    margin-bottom: 0 !important;
}

/* Enhanced badge styling for doctors and medications */
.doctor-badge, .medication-badge {
    max-width: 100%;
    white-space: normal;
    word-wrap: break-word;
    line-height: 1.3;
    padding: 0.4rem 0.6rem;
    font-size: 0.85rem;
    display: inline-block;
}

.doctors-container, .medications-container {
    gap: 0.25rem;
    min-height: 2rem; /* Ensures container has minimum height */
}

/* Make sure badges don't get cut off */
.doctor-badge {
    background-color: #0d6efd !important;
    border: none;
}

.medication-badge {
    background-color: #198754 !important;
    border: none;
}
.diagnosis-item {
    border-left: 4px solid #0d6efd; /* Blue accent line */
    transition: transform 0.2s ease;
}

.diagnosis-item:hover {
    transform: translateX(5px); /* Slight slide effect on hover */
    background-color: #e3f2fd !important;
}

.diagnosis-name {
    font-weight: 500;
    color: #495057;
    word-wrap: break-word; /* Ensures long text wraps properly */
}

/* Smooth transitions for showing/hiding content */
.collapse {
    transition: height 0.35s ease;
}

/* Responsive design for different screen sizes */
@media (max-width: 768px) {
    /* Styles for tablets and phones */
    #diagnosesToggle {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    
    .badge, .doctor-badge, .medication-badge {
        font-size: 0.75rem;
        margin-bottom: 0.25rem;
        padding: 0.3rem 0.5rem;
    }
    
    .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .btn-group .btn {
        margin-bottom: 0.5rem;
        border-radius: 0.375rem !important;
    }
    
    /* Stack the personal info and medical overview vertically on mobile */
    .col-lg-6 {
        margin-bottom: 1rem;
    }
    
    /* Make labels stack on top of content on small screens */
    .row.mb-3 .col-12.col-sm-4,
    .row .col-12.col-sm-4 {
        margin-bottom: 0.25rem;
    }
}

@media (max-width: 576px) {
    /* Extra small screens */
    .diagnosis-item {
        padding: 0.75rem !important;
        margin-bottom: 0.75rem !important;
    }
    
    .diagnosis-name {
        font-size: 0.9rem;
        line-height: 1.4;
    }
    
    .condition-item {
        padding: 0.4rem 0.6rem;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    
    .doctor-badge, .medication-badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.4rem;
        margin-bottom: 0.5rem;
        display: block;
        width: 100%;
        text-align: center;
    }
    
    .doctors-container, .medications-container {
        flex-direction: column;
    }
    
    /* Make sure text doesn't overflow on very small screens */
    .text-capitalize, .diagnosis-name {
        word-break: break-word;
        hyphens: auto;
    }
}

/* Print styles - if someone wants to print this page */
@media print {
    .btn, .modal, script {
        display: none !important;
    }
    
    .card {
        border: 1px solid #ddd !important;
        box-shadow: none !important;
    }
}
</style>

{% endblock %}