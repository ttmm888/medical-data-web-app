{% extends "base.html" %}
{% block title %}Update Member{% endblock %}
{% block content %}
<h2>Update Member: {{ member.name|capitalize }}</h2>

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, msg in messages %}
      <div class="flash {{ category }}">{{ msg }}</div>
    {% endfor %}
    {%endif %}
{% endwith %}

<hr>

<!-- 1. Update Basic Info -->
<h3>Basic Information</h3>
<form method="POST">
    <input type="hidden" name="action" value="update_basic">
    <label>Name:</label>
    <input type="text" name="name" value="{{ member.name }}" size="60"><br><br>

    <label>Date of Birth:</label>
    <input type="date" name="date_of_birth" value="{{ member.date_of_birth }}"><br><br>

    <label>Gender:</label>
    <select name="gender">
        <option value="Male" {% if member.gender == 'Male' %}selected{% endif %}>Male</option>
        <option value="Female" {% if member.gender == 'Female' %}selected{% endif %}>Female</option>
    </select><br><br>

    <label>Drug Allergy</label>
    <input type="text" name="drug_allergy" value="{{ member.drug_allergy }}"><br><br>

    <label>Underlying Conditions:</label>
    <input type="text"  name="underlying" value="{{ member.underlying }}" size="100"><br><br>

    <button type="submit">Update Basic Info</button>
</form>

<hr>

<!-- 2. Doctors Section -->
<h3>Doctors</h3>
<ul>
{% for doctor in member.doctors %}
    <li>
        {{ doctor.name }}
        <!-- Edit doctor -->
        <form action="{{ url_for('update_member', member_id=member.member_id) }}" method="POST" onsubmit="return confirm('Confirm EDIT??');">
            <input type="hidden" name="action" value="edit_doctor">
            <input type="hidden" name="doctor_id" value="{{ doctor.id }}">
            <input type="text" name="doctor_new_name" placeholder="New name">
            <button>Edit</button>
        </form>
        <!-- Delete doctor -->
        <form action="{{ url_for('update_member', member_id=member.member_id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this item?');">
            <input type="hidden" name="action" value="delete_doctor">
            <input type="hidden" name="doctor_id" value="{{ doctor.id }}">
            <button>Delete</button>
        </form>
    </li>
{% endfor %}
</ul>

<!-- Add new doctor -->
<form method="POST">
    <input type="hidden" name="action" value="add_doctor">
    <input type="text" name="new_doctor" placeholder="New doctor name" size="100">
    <button>Add Doctor</button>
</form>

<hr>

<!-- 3. Medications Section -->
<h3>Medications</h3>
<ul>
{% for med in member.medications %}
    <li>
        {{ med.name }}
        <!-- Edit med -->
        <form action="{{ url_for('update_member', member_id=member.member_id) }}" method="POST" onsubmit="return confirm('Confirm EDIT??');">
            <input type="hidden" name="action" value="edit_medication">
            <input type="hidden" name="medication_id" value="{{ med.id }}">
            <input type="text" name="medication_new_name" placeholder="New name">
            <button type="submit">Edit</button>
        </form>
        <!-- Delete med -->
        <form action="{{ url_for('update_member', member_id=member.member_id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this item?');">
            <input type="hidden" name="action" value="delete_medication">
            <input type="hidden" name="medication_id" value="{{ med.id }}">
            <button type="submit">Delete</button>
        </form>
    </li>
{% endfor %}
</ul>

<!-- Add new medication -->
<form method="POST">
    <input type="hidden" name="action" value="add_medication">
    <input type="text" name="new_medication" placeholder="New medication" size="100">
    <button type="submit">Add Medication</button>
</form>

<hr>

<!-- 4. Diagnosis Section -->
<h3>Diagnosis</h3>
<ul>
{% for diag in member.diagnoses %}
    <li>
        {{ diag.name }}
        <!-- Edit diagnosis -->
        <form action="{{ url_for('update_member', member_id=member.member_id) }}" method="POST" onsubmit="return confirm('Confirm EDIT??')";>
            <input type="hidden" name="action" value="edit_diagnosis">
            <input type="hidden" name="diagnosis_id" value="{{ diag.id }}">
            <input type="text" name="diagnosis_new_name" placeholder="New name">
            <button type="submit">Edit</button>
        </form>
        <!-- Delete diagnosis -->
        <form action="{{ url_for('update_member', member_id=member.member_id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this item?')";>
            <input type="hidden" name="action" value="delete_diagnosis">
            <input type="hidden" name="diagnosis_id" value="{{ diag.id }}">
            <button type="submit">Delete</button>
        </form>
    </li>
{% endfor %}
</ul>

<!-- Add new diagnosis -->
<form method="POST">
    <input type="hidden" name="action" value="add_diagnosis">
    <textarea name="new_diagnosis" placeholder="New diagnosis" cols='100' rows='10'></textarea>
    <button type="submit">Add Diagnosis</button>
</form><br>

<form action="{{ url_for('delete_member', member_id=member.member_id) }}" method="POST" onsubmit="return confirm('CONFIRMATION:Are you sure you want to delete this member?');">
    <button type="submit" style="background:red; color:white;">Delete Member</button>
</form>

<!-- Medical Files Section -->
        <div style="margin: 30px 0;">
            <h2>Medical Files</h2>
            
            <!-- Upload button -->
            <div style="margin: 15px 0;">
                <a href="{{ url_for('upload_file', member_id=member.member_id) }}" 
                   style="padding: 10px 20px; background-color: #28a745; color: white; text-decoration: none; border-radius: 5px;">
                    üìÅ Upload New Medical File
                </a>
            </div>
            
            <!-- Files list -->
            {% if member.medical_files %}
                <table border="1" style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 10px; text-align: left;">File Name</th>
                            <th style="padding: 10px; text-align: left;">Description</th>
                            <th style="padding: 10px; text-align: left;">Upload Date</th>
                            <th style="padding: 10px; text-align: left;">File Size</th>
                            <th style="padding: 10px; text-align: left;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in member.medical_files %}
                            <tr>
                                <td style="padding: 10px;">
                                    <strong>{{ file.filename }}</strong>
                                </td>
                                <td style="padding: 10px;">{{ file.description if file.description else 'No description' }}</td>
                                <td style="padding: 10px;">{{ file.uploaded_at.strftime('%b %d, %Y at %I:%M %p') }}</td>
                                <td style="padding: 10px;">
                                    {% if file.file_size %}
                                        {% if file.file_size < 1024 %}
                                            {{ file.file_size }} bytes
                                        {% elif file.file_size < 1048576 %}
                                            {{ "%.1f"|format(file.file_size/1024) }} KB
                                        {% else %}
                                            {{ "%.1f"|format(file.file_size/1048576) }} MB
                                        {% endif %}
                                    {% else %}
                                        Unknown
                                    {% endif %}
                                </td>
                                <td style="padding: 10px;">
                                    <a href="{{ url_for('download_file', file_id=file.id) }}" 
                                       style="padding: 5px 10px; background-color: #007bff; color: white; text-decoration: none; margin-right: 5px;">
                                        üì• Download
                                    </a>
                                    <form method="POST" 
                                          action="{{ url_for('delete_file', file_id=file.id) }}" 
                                          style="display: inline;"
                                          onsubmit="return confirm('Are you sure you want to delete this file?')">
                                        <button type="submit" 
                                                style="padding: 5px 10px; background-color: #dc3545; color: white; border: none; cursor: pointer;">
                                            üóëÔ∏è Delete
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <p><strong>Total files:</strong> {{ member.medical_files|length }}</p>
            {% else %}
                <div style="padding: 20px; background-color: #f8f9fa; margin: 20px 0;">
                    <p>No medical files uploaded yet.</p>
                    <p>You can upload medical reports, lab results, X-rays, prescriptions, and other medical documents.</p>
                    <a href="{{ url_for('upload_file', member_id=member.member_id) }}" 
                       style="padding: 10px 20px; background-color: #28a745; color: white; text-decoration: none;">
                        üìÅ Upload First Medical File
                    </a>
                </div>
            {% endif %}
        </div>

{% endblock %}
